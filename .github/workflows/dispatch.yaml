name: Update Submodule

on:
  repository_dispatch:
    types: [openapi-update]

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  check_submodules_for_updates:
    timeout-minutes: 10

    runs-on: ubuntu-latest

    outputs:
      pr-list: ${{ steps.pr-list.outputs.pr-list }}
      status: ${{ steps.status.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Update submodules
        id: update
        run: git submodule update --remote --recursive

      - name: Run git status
        id: status
        run: echo "status=$(git status -s)" >> $GITHUB_OUTPUT

      - name: Get Submodule PR
        id: pr-list
        if: ${{ steps.status.outputs.status }}
        run: |
          pr_list=$(gh pr list --label "submodule" --json number | jq '[.[].number]')
          echo "pr-list=$(echo $pr_list | jq -c .)" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get the latest merge PR for OpenAPI
        id: openapi-pr
        if: ${{ steps.status.outputs.status }}
        run: |
          merged_pr=$(
            curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.OPENAPI_GITHUB_TOKEN }}" \
            https://api.github.com/search/issues?q=repo:kamegoro/create-repository-check-operation-of-dispatch-events+is:pr+is:merged
          )
          echo "merged-pr=$(echo $merged_pr | jq '.items[0]')" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.OPENAPI_GITHUB_TOKEN }}

      - name: Install Node.js
        if: ${{ steps.status.outputs.status }}
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        if: ${{ steps.status.outputs.status }}
        run: npm install

      - name: Create Branch Name
        if: ${{ steps.status.outputs.status }}
        env:
          TZ: "Asia/Tokyo"
        run: echo "SUBMODULE_BRANCH_NAME=feature/Update-submodules-$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_ENV

      - name: Create new Branch
        if: ${{ steps.status.outputs.status }}
        id: branch
        run: |
          git checkout -b ${{ env.SUBMODULE_BRANCH_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Orval
        if: ${{ steps.status.outputs.status }}
        run: npm run orval

      - name: commit and push files
        if: ${{ steps.status.outputs.status }}
        run: |
          git add .
          git config --local user.email "tentyo0620@icloud.com"
          git config --local user.name "kamegoro"
          git commit -m "Update submodules at $(date "+%Y-%m-%d %H:%M:%S")"
          git push origin ${{ env.SUBMODULE_BRANCH_NAME }}

      - name: Create PR
        if: ${{ steps.status.outputs.status }}
        run: |
          gh pr create \
            -B main \
            -H ${{ env.SUBMODULE_BRANCH_NAME }} \
            --reviewer kamegoro \
            --label submodule \
            --title ${{ steps.openapi-pr.outputs.merged-pr.title }} \
            --body 'Created by Github'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  close_old_pr:
    needs: check_submodules_for_updates
    if: needs.check_submodules_for_updates.outputs.status && !contains(toJson(needs.check_submodules_for_updates.outputs.pr-list), '[]')

    timeout-minutes: 10

    runs-on: ubuntu-latest

    strategy:
      matrix:
        value: ${{ fromJson(needs.check_submodules_for_updates.outputs.pr-list) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Close PR
        run: |
          gh pr close ${{ matrix.value }} --delete-branch
        env:
          GITHUB_TOKEN: ${{ github.token }}
